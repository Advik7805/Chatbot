<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Monitor AI Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñ•Ô∏è System Monitor AI</h1>
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span id="connectionStatus">Connected</span>
            </div>
        </div>

        <div class="main-content">
            <div class="metrics-grid">
                <div class="metric-card cpu">
                    <div class="metric-value" id="cpuUsage">--</div>
                    <div class="metric-label">CPU Usage</div>
                </div>
                <div class="metric-card memory">
                    <div class="metric-value" id="memoryUsage">--</div>
                    <div class="metric-label">Memory Usage</div>
                </div>
                <div class="metric-card disk">
                    <div class="metric-value" id="diskUsage">--</div>
                    <div class="metric-label">Disk Usage</div>
                </div>
                <div class="metric-card network">
                    <div class="metric-value" id="networkStatus">--</div>
                    <div class="metric-label">Network Status</div>
                </div>
            </div>
            <!-- Realtime Chart -->
            <div class="chart-container">
                <h3>‚è±Ô∏è Realtime System Metrics</h3>
                <canvas id="realtimeChart" width="400" height="200"></canvas>
            </div>
        </div>

        <div class="chatbot-panel">
            <div class="chatbot-header">
                <h2>
                    <div class="ai-icon">ü§ñ</div>
                    AI System Assistant
                </h2>
                <p style="font-size: 0.9em; opacity: 0.9; margin-top: 5px;">
                    Maintenance Prediction & Energy Optimization
                </p>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message system">
                    üöÄ AI Assistant initialized. I can help with maintenance predictions, energy optimization, and system analysis.
                </div>
                <div class="suggestions">
                    <div class="suggestion" onclick="sendSuggestion('Analyze current system health')">üîç System Health</div>
                    <div class="suggestion" onclick="sendSuggestion('Predict maintenance needs')">üîß Maintenance</div>
                    <div class="suggestion" onclick="sendSuggestion('Optimize energy consumption')">‚ö° Energy Tips</div>
                    <div class="suggestion" onclick="sendSuggestion('Show performance trends')">üìà Trends</div>
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>

          <div class="chat-input">
            <div class="input-group">
                <input type="text" id="chatInput" placeholder="Loading system data..." disabled />
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                    ‚û§
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Socket.io Connection & UI Elements ---
    const socket = io("http://localhost:3000");
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typingIndicator');
    const connectionStatus = document.getElementById('connectionStatus');
    let isFirstFetch = true; // Flag to track the first data fetch

    // --- Socket Event Handlers ---
    socket.on('connect', () => {
        console.log('‚úÖ Connected to the server!');
        connectionStatus.textContent = 'Connected';
        document.querySelector('.status-dot').style.background = '#48bb78';
    });

    // Extra visibility for connection issues
    socket.on('connect_error', (err) => {
        console.error('‚ö†Ô∏è Socket connect_error:', err && err.message ? err.message : err);
        connectionStatus.textContent = 'Error';
        document.querySelector('.status-dot').style.background = '#f6ad55';
        addMessageToUI('system', `Socket error: ${err && err.message ? err.message : 'Unknown error'}`);
    });
    socket.on('error', (err) => {
        console.error('‚ö†Ô∏è Socket error:', err && err.message ? err.message : err);
        addMessageToUI('system', `Socket error: ${err && err.message ? err.message : 'Unknown error'}`);
    });

    socket.on('disconnect', () => {
        console.warn('Disconnected from the server.');
        connectionStatus.textContent = 'Disconnected';
        document.querySelector('.status-dot').style.background = '#f56565';
    });
    // --- Listener for RECEIVING bot responses ---
    let responseTimeoutId = null;
    socket.on('botResponse', (response) => {
        if (responseTimeoutId) {
            clearTimeout(responseTimeoutId);
            responseTimeoutId = null;
        }
        typingIndicator.style.display = 'none'; // Hide typing indicator
        addMessageToUI('bot', response);
    });

    // --- Function to add messages to the chat window ---
    function addMessageToUI(sender, text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        messageDiv.textContent = text;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll
    }
    // --- Functions to send messages ---
    function sendMessage() {
        const message = chatInput.value.trim();
        if (message) {
            addMessageToUI('user', message);
            // Send message along with the latest system stats
            socket.emit('sendMessage', message, currentSystemStats);
            chatInput.value = '';
            typingIndicator.style.display = 'block'; // Show typing indicator
            if (responseTimeoutId) clearTimeout(responseTimeoutId);
            responseTimeoutId = setTimeout(() => {
                typingIndicator.style.display = 'none';
                addMessageToUI('system', 'No response from the assistant. Please try again.');
            }, 10000);
        }
    }

    // This function handles the suggestion buttons
    function sendSuggestion(text) {
        addMessageToUI('user', text);
        socket.emit('sendMessage', text, currentSystemStats);
        typingIndicator.style.display = 'block';
        if (responseTimeoutId) clearTimeout(responseTimeoutId);
        responseTimeoutId = setTimeout(() => {
            typingIndicator.style.display = 'none';
            addMessageToUI('system', 'No response from the assistant. Please try again.');
        }, 10000);
    }
    
    // --- Event Listeners for user input ---
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    // --- Realtime Chart Setup ---
    const realtimeLabels = [];
    const cpuData = [];
    const memData = [];
    const diskData = [];
    let currentSystemStats = {}; // To hold live data for the chatbot
    const maxPoints = 30; // Show last 30 points
    

    const realtimeChart = new Chart(document.getElementById('realtimeChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: realtimeLabels,
            datasets: [
                {
                    label: 'CPU (%)',
                    data: cpuData,
                    borderColor: '#36a2eb',
                    backgroundColor: 'rgba(54,162,235,0.1)',
                    fill: true,
                    tension: 0.3,
                },
                {
                    label: 'Memory (%)',
                    data: memData,
                    borderColor: '#4bc0c0',
                    backgroundColor: 'rgba(75,192,192,0.1)',
                    fill: true,
                    tension: 0.3,
                },
                {
                    label: 'Disk (%)',
                    data: diskData,
                    borderColor: '#ff6384',
                    backgroundColor: 'rgba(255,99,132,0.1)',
                    fill: true,
                    tension: 0.3,
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true }
            },
            scales: {
                y: {
                    min: 0,
                    max: 100,
                    ticks: { stepSize: 20 }
                }
            }
        }
    });

    async function fetchStats() {
        try {
            const response = await fetch('http://localhost:3000/stats');
            const data = await response.json();
             currentSystemStats = data; // Store the entire data object for the chatbot
             if (isFirstFetch) {
            // Enable the text input field
            document.getElementById('chatInput').disabled = false;
            
            // Enable the send button
            document.getElementById('sendBtn').disabled = false;
            
            // Update the placeholder text to be more helpful
            document.getElementById('chatInput').placeholder = "Ask about system maintenance, optimization, or performance...";
            
            // Set the flag to false so this code never runs again
            isFirstFetch = false; 
        }
            // CPU Usage
            if (data.cpu && typeof data.cpu.currentLoad === 'number') {
                document.getElementById('cpuUsage').textContent = data.cpu.currentLoad.toFixed(1) + '%';
            }
            // Memory Usage
            if (data.memory && typeof data.memory.used === 'number' && typeof data.memory.total === 'number') {
                const memPercent = (data.memory.used / data.memory.total) * 100;
                document.getElementById('memoryUsage').textContent = memPercent.toFixed(1) + '%';
            }
            // Disk Usage
            if (data.disks && Array.isArray(data.disks) && data.disks.length > 0) {
                const disk = data.disks[0];
                if (disk && typeof disk.used === 'number' && typeof disk.size === 'number') {
                    const diskPercent = (disk.used / disk.size) * 100;
                    document.getElementById('diskUsage').textContent = diskPercent.toFixed(1) + '%';
                }
            }
            // Network Status
            if (data.network && Array.isArray(data.network) && data.network.length > 0) {
                const net = data.network[0];
                document.getElementById('networkStatus').textContent =
                    `‚Üë${(net.tx_sec/1024).toFixed(1)}KB/s ‚Üì${(net.rx_sec/1024).toFixed(1)}KB/s`;
            }

            // --- Update Realtime Chart ---
            const now = new Date();
            const label = now.getHours().toString().padStart(2, '0') + ':' +
                          now.getMinutes().toString().padStart(2, '0') + ':' +
                          now.getSeconds().toString().padStart(2, '0');
            // Push new data
            realtimeLabels.push(label);
            cpuData.push(data.cpu && typeof data.cpu.currentLoad === 'number' ? data.cpu.currentLoad : null);
            memData.push(data.memory && typeof data.memory.used === 'number' && typeof data.memory.total === 'number'
                ? (data.memory.used / data.memory.total) * 100 : null);
            diskData.push(data.disks && Array.isArray(data.disks) && data.disks.length > 0 && typeof data.disks[0].used === 'number' && typeof data.disks[0].size === 'number'
                ? (data.disks[0].used / data.disks[0].size) * 100 : null);
            // Keep only last maxPoints
            if (realtimeLabels.length > maxPoints) {
                realtimeLabels.shift();
                cpuData.shift();
                memData.shift();
                diskData.shift();
            }
            realtimeChart.update();
        } catch (err) {
            document.getElementById('cpuUsage').textContent = '--';
            document.getElementById('memoryUsage').textContent = '--';
            document.getElementById('diskUsage').textContent = '--';
            document.getElementById('networkStatus').textContent = '--';
        }
    }
   

    // Fetch stats every 2 seconds
    fetchStats();
    setInterval(fetchStats, 2000);
    </script>
</body>
</html>